<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zorgcapaciteit Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
      defer
    ></script>

    <style>
      .card {
        margin-bottom: 20px;
      }
      .table-container {
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .sort-icon {
        display: inline-block;
        cursor: pointer;
        margin-left: 5px;
        width: 1em; /* Give it some consistent width */
        text-align: center;
      }
      .table th {
        cursor: pointer;
        white-space: nowrap; /* Prevent header text wrapping */
      }
      .rating-high {
        color: #198754; /* Bootstrap 5 Success Green */
        font-weight: bold;
      }
      .rating-medium {
        color: #ffc107; /* Bootstrap 5 Warning Yellow */
        font-weight: bold;
      }
      .rating-low {
        color: #dc3545; /* Bootstrap 5 Danger Red */
        font-weight: bold;
      }
      .rating-na {
        color: #6c757d; /* Bootstrap 5 Secondary Gray */
        font-style: italic;
      }
      .download-btn {
        margin-bottom: 20px;
      }
      .loading {
        text-align: center;
        padding: 30px;
        font-style: italic;
        color: #6c757d;
      }
      .error-message {
        color: #dc3545;
        background-color: #f8d7da; /* Light red background */
        border-color: #f5c2c7; /* Darker red border */
        padding: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        margin-bottom: 20px;
      }
      /* Align search and download button nicely */
      .controls-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Allow wrapping on small screens */
        gap: 10px; /* Add some space between items */
      }
      .search-input {
        flex-grow: 1; /* Allow search input to take available space */
        min-width: 200px; /* Ensure it doesn't get too small */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mt-4 mb-4 text-center">Zorgcapaciteit Dashboard</h1>

      <ul class="nav nav-tabs" id="regionTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="arnhem-tab"
            data-bs-toggle="tab"
            data-bs-target="#arnhem"
            type="button"
            role="tab"
            aria-controls="arnhem"
            aria-selected="true"
          >
            Arnhem
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="nijmegen-tab"
            data-bs-toggle="tab"
            data-bs-target="#nijmegen"
            type="button"
            role="tab"
            aria-controls="nijmegen"
            aria-selected="false"
          >
            Nijmegen
          </button>
        </li>
      </ul>

      <div class="tab-content" id="regionTabContent">
        <div
          class="tab-pane fade show active"
          id="arnhem"
          role="tabpanel"
          aria-labelledby="arnhem-tab"
          tabindex="0"
        >
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  Verpleeghuis Bedden (Arnhem)
                </div>
                <div class="card-body">
                  <h3 id="nursingHomeBedsArnhem" class="card-title">0</h3>
                  <p class="card-text">
                    Beschikbare bedden in
                    <span id="totalNursingHomesArnhem">0</span> verpleeghuizen.
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-success text-white">
                  Eerstelijnsverblijf (ELV) Bedden (Arnhem)
                </div>
                <div class="card-body">
                  <h3 id="firstLineBedsArnhem" class="card-title">0</h3>
                  <p class="card-text">Beschikbare ELV-bedden.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-danger text-white">
                  Crisis Bedden (Arnhem)
                </div>
                <div class="card-body">
                  <h3 id="crisisBedsArnhem" class="card-title">0</h3>
                  <p class="card-text">Beschikbare crisisbedden.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  Wachttijden &amp; Bezettingsgraad (Arnhem)
                </div>
                <div class="card-body">
                  <p id="waitingTimeArnhem" class="card-text">
                    Wachttijd: 0 dagen
                  </p>
                  <p id="occupancyRateArnhem" class="card-text">
                    Bezettingsgraad: 0%
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4 mb-3 controls-row">
            <div class="search-input">
              <input
                type="text"
                id="searchArnhem"
                class="form-control"
                placeholder="Zoeken op naam of locatie..."
              />
            </div>
            <div>
              <button
                id="downloadCsvArnhem"
                class="btn btn-success download-btn"
              >
                <i class="fas fa-download"></i> Download CSV
              </button>
            </div>
          </div>

          <div id="arnhemLoadingIndicator" class="loading">
            Gegevens worden geladen...
          </div>
          <div
            id="arnhemErrorMessage"
            class="error-message"
            style="display: none"
          >
            Er is een fout opgetreden bij het laden van de gegevens.
          </div>
          <div
            class="table-responsive"
            id="arnhemTableContainer"
            style="display: none"
          >
            <table
              id="arnhemTable"
              class="table table-striped table-bordered table-hover"
            >
              <thead class="table-light">
                <tr>
                  <th data-sort="Naam">
                    Naam <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Locatie">
                    Locatie <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Afstand">
                    Afstand (km) <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Cijfer">
                    Cijfer <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Aantal Waarderingen">
                    Waarderingen <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Aantal Plaatsen">
                    Aantal plaatsen <span class="sort-icon">↕️</span>
                  </th>
                </tr>
              </thead>
              <tbody id="arnhemTableBody"></tbody>
            </table>
            <div
              id="arnhemNoResults"
              class="alert alert-info text-center"
              style="display: none"
            >
              Geen resultaten gevonden.
            </div>
          </div>

          <div class="text-muted small mt-3">
            Bron:
            <a
              href="https://www.zorgkaartnederland.nl/verpleeghuis-en-verzorgingshuis"
              target="_blank"
              rel="noopener noreferrer"
            >
              ZorgkaartNederland.nl
            </a>
            <p class="mt-1">
              Aantal zorghuizen weergegeven:
              <span id="totalDisplayedArnhem">0</span>
            </p>
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="nijmegen"
          role="tabpanel"
          aria-labelledby="nijmegen-tab"
          tabindex="0"
        >
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  Verpleeghuis Bedden (Nijmegen)
                </div>
                <div class="card-body">
                  <h3 id="nursingHomeBedsNijmegen" class="card-title">0</h3>
                  <p class="card-text">
                    Beschikbare bedden in
                    <span id="totalNursingHomesNijmegen">0</span>
                    verpleeghuizen.
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-success text-white">
                  Eerstelijnsverblijf (ELV) Bedden (Nijmegen)
                </div>
                <div class="card-body">
                  <h3 id="firstLineBedsNijmegen" class="card-title">0</h3>
                  <p class="card-text">Beschikbare ELV-bedden.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-danger text-white">
                  Crisis Bedden (Nijmegen)
                </div>
                <div class="card-body">
                  <h3 id="crisisBedsNijmegen" class="card-title">0</h3>
                  <p class="card-text">Beschikbare crisisbedden.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  Wachttijden &amp; Bezettingsgraad (Nijmegen)
                </div>
                <div class="card-body">
                  <p id="waitingTimeNijmegen" class="card-text">
                    Wachttijd: 0 dagen
                  </p>
                  <p id="occupancyRateNijmegen" class="card-text">
                    Bezettingsgraad: 0%
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-4 mb-3 controls-row">
            <div class="search-input">
              <input
                type="text"
                id="searchNijmegen"
                class="form-control"
                placeholder="Zoeken op naam of locatie..."
              />
            </div>
            <div>
              <button
                id="downloadCsvNijmegen"
                class="btn btn-success download-btn"
              >
                <i class="fas fa-download"></i> Download CSV
              </button>
            </div>
          </div>

          <div id="nijmegenLoadingIndicator" class="loading">
            Gegevens worden geladen...
          </div>
          <div
            id="nijmegenErrorMessage"
            class="error-message"
            style="display: none"
          >
            Er is een fout opgetreden bij het laden van de gegevens.
          </div>
          <div
            class="table-responsive"
            id="nijmegenTableContainer"
            style="display: none"
          >
            <table
              id="nijmegenTable"
              class="table table-striped table-bordered table-hover"
            >
              <thead class="table-light">
                <tr>
                  <th data-sort="Naam">
                    Naam <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Locatie">
                    Locatie <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Afstand">
                    Afstand (km) <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Cijfer">
                    Cijfer <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Aantal Waarderingen">
                    Waarderingen <span class="sort-icon">↕️</span>
                  </th>
                  <th data-sort="Aantal Plaatsen">
                    Aantal plaatsen <span class="sort-icon">↕️</span>
                  </th>
                </tr>
              </thead>
              <tbody id="nijmegenTableBody"></tbody>
            </table>
            <div
              id="nijmegenNoResults"
              class="alert alert-info text-center"
              style="display: none"
            >
              Geen resultaten gevonden.
            </div>
          </div>

          <div class="text-muted small mt-3">
            Bron:
            <a
              href="https://www.zorgkaartnederland.nl/verpleeghuis-en-verzorgingshuis"
              target="_blank"
              rel="noopener noreferrer"
            >
              ZorgkaartNederland.nl
            </a>
            <p class="mt-1">
              Aantal zorghuizen weergegeven:
              <span id="totalDisplayedNijmegen">0</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- Constants and State ---
      const zorghuizenData = {
        arnhem: [],
        nijmegen: [],
      };

      // Default dashboard data structure
      let dashboardData = {
        arnhem: {
          nursingHomeBeds: "N/A",
          firstLineBeds: "N/A",
          crisisBeds: "N/A",
          waitingTime: "N/A",
          occupancyRate: "N/A",
          totalNursingHomes: 0,
        },
        nijmegen: {
          nursingHomeBeds: "N/A",
          firstLineBeds: "N/A",
          crisisBeds: "N/A",
          waitingTime: "N/A",
          occupancyRate: "N/A",
          totalNursingHomes: 0,
        },
      };

      const sortConfig = {
        arnhem: { key: "Cijfer", direction: "descending" },
        nijmegen: { key: "Cijfer", direction: "descending" },
      };

      const filters = {
        arnhem: "",
        nijmegen: "",
      };

      // --- Helper Functions ---

      // Safely update element text content
      const updateElementText = (id, text) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = text;
        } else {
          console.warn(`Element with ID ${id} not found.`);
        }
      };

      // Escape data for CSV format
      const escapeCSV = (field) => {
        const str = String(field ?? ""); // Convert null/undefined to empty string
        // If field contains comma, quote, or newline, enclose in double quotes
        if (str.includes(",") || str.includes('"') || str.includes("\n")) {
          // Escape existing double quotes by doubling them
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      };

      // --- Core Logic Functions ---

      // Load dashboard summary data (optional file)
      async function loadDashboardSummary() {
        try {
          const response = await fetch("dashboard-data.json"); // Assume this file exists
          if (!response.ok) {
            console.warn(
              `Could not load dashboard-data.json (Status: ${response.status}). Using default values.`
            );
            // Keep default dashboardData
          } else {
            const loadedData = await response.json();
            // Merge loaded data with defaults to ensure structure
            dashboardData.arnhem = {
              ...dashboardData.arnhem,
              ...loadedData.arnhem,
            };
            dashboardData.nijmegen = {
              ...dashboardData.nijmegen,
              ...loadedData.nijmegen,
            };
            console.log("Dashboard summary data loaded.");
          }
        } catch (error) {
          console.warn(
            `Error fetching or parsing dashboard-data.json: ${error}. Using default values.`
          );
          // Keep default dashboardData
        }
        // Update UI for both regions after attempting load
        updateDashboardUI("arnhem");
        updateDashboardUI("nijmegen");
      }

      // Load detailed data for a specific region
      async function loadRegionData(region, jsonFile) {
        const loadingIndicator = document.getElementById(
          `${region}LoadingIndicator`
        );
        const tableContainer = document.getElementById(
          `${region}TableContainer`
        );
        const errorMessage = document.getElementById(`${region}ErrorMessage`);

        // Ensure elements exist before manipulating style
        if (!loadingIndicator || !tableContainer || !errorMessage) {
          console.error(`UI elements not found for region: ${region}`);
          return;
        }

        console.log(`[${region}] Starting loadRegionData for ${jsonFile}`);
        loadingIndicator.style.display = "block";
        tableContainer.style.display = "none";
        errorMessage.style.display = "none"; // Hide previous errors

        try {
          console.log(`[${region}] Fetching ${jsonFile}...`);
          const response = await fetch(jsonFile);
          console.log(`[${region}] Fetch response status: ${response.status}`);

          if (!response.ok) {
            throw new Error(
              `Server response was not OK: ${response.status} ${response.statusText} for ${jsonFile}`
            );
          }

          console.log(`[${region}] Parsing JSON...`);
          const data = await response.json();
          // Basic validation: check if it's an array
          if (!Array.isArray(data)) {
            throw new Error(`Data loaded from ${jsonFile} is not an array.`);
          }
          console.log(
            `[${region}] JSON parsed successfully. Items: ${data.length}`
          );
          zorghuizenData[region] = data;

          // --- NIEUW: Update het totaal aantal verpleeghuizen in de card ---
          const totalCount = zorghuizenData[region].length;
          const capitalizedRegion =
            region.charAt(0).toUpperCase() + region.slice(1);
          const totalHomesId = `totalNursingHomes${capitalizedRegion}`;
          updateElementText(totalHomesId, totalCount.toString());
          // --- EINDE NIEUW ---

          populateTable(region); // Populate table with new data

          loadingIndicator.style.display = "none";
          tableContainer.style.display = "block"; // Show table container (which includes table and no-results div)
          console.log(`[${region}] Load successful, UI updated.`);
        } catch (error) {
          console.error(
            `[${region}] ERROR in loadRegionData for ${jsonFile}:`,
            error
          );
          loadingIndicator.style.display = "none";
          // Provide a more user-friendly error message
          errorMessage.textContent = `Fout bij laden data voor ${region} (${jsonFile}): ${error.message}. Controleer of het bestand bestaat en correct is. Zie console voor details.`;
          errorMessage.style.display = "block";
          zorghuizenData[region] = []; // Clear data on error

          // --- NIEUW: Zet telling op 0 bij fout ---
          const capitalizedRegionOnError =
            region.charAt(0).toUpperCase() + region.slice(1);
          const totalHomesIdOnError = `totalNursingHomes${capitalizedRegionOnError}`;
          updateElementText(totalHomesIdOnError, "0");
          // --- EINDE NIEUW ---

          populateTable(region); // Re-populate to show 'no results' message
          tableContainer.style.display = "block"; // Ensure container is visible to show the error/no-results
        }
      }

      // Update the summary cards
      function updateDashboardUI(region) {
        const data = dashboardData[region];
        if (!data) {
          console.warn(`No dashboard data found for region: ${region}`);
          return;
        }

        const capitalized = region.charAt(0).toUpperCase() + region.slice(1);

        updateElementText(
          `nursingHomeBeds${capitalized}`,
          data.nursingHomeBeds ?? "N/A"
        );
        updateElementText(
          `firstLineBeds${capitalized}`,
          data.firstLineBeds ?? "N/A"
        );
        updateElementText(`crisisBeds${capitalized}`, data.crisisBeds ?? "N/A");
        updateElementText(
          `waitingTime${capitalized}`,
          `Wachttijd: ${data.waitingTime ?? "N/A"} dagen`
        );
        updateElementText(
          `occupancyRate${capitalized}`,
          `Bezettingsgraad: ${data.occupancyRate ?? "N/A"}%`
        );
        updateElementText(
          `totalNursingHomes${capitalized}`,
          data.totalNursingHomes?.toString() ?? "0"
        );
      }

      // Populate the main table for a region
      function populateTable(region) {
        const tableBody = document.getElementById(`${region}TableBody`);
        const noResultsDiv = document.getElementById(`${region}NoResults`);
        const totalDisplayedSpan = document.getElementById(
          `totalDisplayed${region.charAt(0).toUpperCase() + region.slice(1)}`
        );
        const tableContainer = document.getElementById(
          `${region}TableContainer`
        ); // Need this to hide/show table

        if (
          !tableBody ||
          !noResultsDiv ||
          !totalDisplayedSpan ||
          !tableContainer
        ) {
          console.error(`Table UI elements not found for region: ${region}`);
          return;
        }

        tableBody.innerHTML = ""; // Clear previous results

        let processedData = Array.isArray(zorghuizenData[region])
          ? [...zorghuizenData[region]] // Create a copy to sort/filter
          : [];

        // Apply filtering
        if (filters[region]) {
          const filterText = filters[region].toLowerCase().trim();
          if (filterText) {
            processedData = processedData.filter(
              (item) =>
                (item.Naam && item.Naam.toLowerCase().includes(filterText)) ||
                (item.Locatie &&
                  item.Locatie.toLowerCase().includes(filterText))
            );
          }
        }

        // Apply sorting
        try {
          const { key, direction } = sortConfig[region];
          processedData.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            // Handle numeric sort for Cijfer and Aantal Waarderingen
            if (key === "Cijfer" || key === "Aantal Waarderingen") {
              valA = valA !== null && !isNaN(valA) ? Number(valA) : -Infinity; // Treat non-numbers/null as very small
              valB = valB !== null && !isNaN(valB) ? Number(valB) : -Infinity;
            } else if (key === "Afstand") {
              // Basic numeric sort for distance (assuming "X km" format or just number)
              valA = parseFloat(String(valA)) ?? Infinity;
              valB = parseFloat(String(valB)) ?? Infinity;
            } else if (key === "Afstand") {
              // Basic numeric sort for distance (assuming "X km" format or just number)
              valA = parseFloat(String(valA)) ?? Infinity;
              valB = parseFloat(String(valB)) ?? Infinity;
            } else {
              // Default string sort (case-insensitive)
              valA = String(valA ?? "").toLowerCase(); // Handle null/undefined
              valB = String(valB ?? "").toLowerCase();
            }

            if (valA < valB) return direction === "ascending" ? -1 : 1;
            if (valA > valB) return direction === "ascending" ? 1 : -1;
            return 0;
          });
        } catch (sortError) {
          console.error(
            `Error during sorting for region ${region}:`,
            sortError
          );
          // Continue without sorting or with partially sorted data
        }

        // Display results or 'no results' message
        if (processedData.length === 0) {
          noResultsDiv.style.display = "block";
          tableBody.style.display = "none"; // Hide the tbody itself
        } else {
          noResultsDiv.style.display = "none";
          tableBody.style.display = ""; // Show the tbody

          processedData.forEach((item) => {
            const row = tableBody.insertRow(); // More efficient than createElement + innerHTML

            const cijferValue = item.Cijfer;
            let cijferClass = "rating-na";
            let displayCijfer = "N/A";

            // FIXED: Check if Cijfer is a valid number before formatting
            if (
              cijferValue !== null &&
              typeof cijferValue === "number" &&
              !isNaN(cijferValue)
            ) {
              displayCijfer = cijferValue.toFixed(1);
              if (cijferValue >= 8.5)
                cijferClass = "rating-high"; // Adjusted thresholds slightly
              else if (cijferValue >= 6.5) cijferClass = "rating-medium";
              else cijferClass = "rating-low";
            }

            // Add cells safely, providing fallbacks
            row.insertCell().textContent = item.Naam || "Onbekend";
            row.insertCell().textContent = item.Locatie || "Onbekend";
            row.insertCell().textContent =
              item.Afstand != null ? `${item.Afstand} km` : "N/A"; // Assuming Afstand is just number
            const cijferCell = row.insertCell();
            cijferCell.textContent = displayCijfer;
            cijferCell.className = cijferClass; // Apply class to the cell
            row.insertCell().textContent = item["Aantal Waarderingen"] ?? "N/A";
            row.insertCell().textContent =
              item["Aantal Plaatsen"] ?? "N/A"; // Assuming this is a number
          });
        }

        totalDisplayedSpan.textContent = processedData.length;
        updateSortIcons(region);
      }

      // Update visual indicators on table headers for sorting
      function updateSortIcons(region) {
        const headers = document.querySelectorAll(
          `#${region}Table th[data-sort]`
        ); // Target only sortable headers
        headers.forEach((header) => {
          const key = header.getAttribute("data-sort");
          const sortIcon = header.querySelector(".sort-icon");
          if (!sortIcon) return;

          if (key === sortConfig[region].key) {
            sortIcon.textContent =
              sortConfig[region].direction === "ascending" ? "↑" : "↓";
          } else {
            sortIcon.textContent = "↕️";
          }
        });
      }

      // Handle click on a table header for sorting
      function handleSortClick(headerElement, region) {
        if (!headerElement) return;
        const key = headerElement.getAttribute("data-sort");
        if (!key) return; // Clicked non-sortable part of header

        if (sortConfig[region].key === key) {
          // Toggle direction
          sortConfig[region].direction =
            sortConfig[region].direction === "ascending"
              ? "descending"
              : "ascending";
        } else {
          // Sort new column, default descending for Cijfer/Waarderingen, ascending otherwise
          sortConfig[region].key = key;
          sortConfig[region].direction =
            key === "Cijfer" ||
            key === "Aantal Waarderingen" ||
            key === "Aantal Plaatsen"
              ? "descending"
              : "ascending";
        }
        populateTable(region); // Re-render table with new sort order
      }

      // Generate and trigger download of CSV file
      function downloadCSV(region) {
        let dataToExport = Array.isArray(zorghuizenData[region])
          ? [...zorghuizenData[region]]
          : [];

        // Apply current filter to exported data
        if (filters[region]) {
          const filterText = filters[region].toLowerCase().trim();
          if (filterText) {
            dataToExport = dataToExport.filter(
              (item) =>
                (item.Naam && item.Naam.toLowerCase().includes(filterText)) ||
                (item.Locatie &&
                  item.Locatie.toLowerCase().includes(filterText))
            );
          }
        }

        // Apply current sort order to exported data (optional, but good for consistency)
        try {
          const { key, direction } = sortConfig[region];
          dataToExport.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];
            // Simple sort logic (repeat from populateTable or refactor)
            if (key === "Cijfer" || key === "Aantal Waarderingen") {
              valA = valA !== null && !isNaN(valA) ? Number(valA) : -Infinity;
              valB = valB !== null && !isNaN(valB) ? Number(valB) : -Infinity;
            } else if (key === "Afstand") {
              valA = parseFloat(String(valA)) ?? Infinity;
              valB = parseFloat(String(valB)) ?? Infinity;
            } else if (key === "Aantal Plaatsen") {
              valA = parseFloat(String(valA)) ?? Infinity;
              valB = parseFloat(String(valB)) ?? Infinity;
            } else {
              valA = String(valA ?? "").toLowerCase();
              valB = String(valB ?? "").toLowerCase();
            }
            if (valA < valB) return direction === "ascending" ? -1 : 1;
            if (valA > valB) return direction === "ascending" ? 1 : -1;
            return 0;
          });
        } catch (sortError) {
          console.warn("Could not sort data for CSV export:", sortError);
        }

        const headers = [
          "Naam",
          "Locatie",
          "Afstand (km)",
          "Cijfer",
          "Aantal Waarderingen",
          "Aantal Plaatsen",
        ];
        let csvContent = headers.map(escapeCSV).join(",") + "\n"; // Header row

        dataToExport.forEach((item) => {
          // FIXED: Check Cijfer before using toFixed()
          const formattedCijfer =
            item.Cijfer !== null &&
            typeof item.Cijfer === "number" &&
            !isNaN(item.Cijfer)
              ? item.Cijfer.toFixed(1)
              : ""; // Use empty string for N/A in CSV

          const rowData = [
            item.Naam,
            item.Locatie,
            item.Afstand, // Keep raw distance number
            formattedCijfer,
            item["Aantal Waarderingen"],
            item["Aantal Plaatsen"],
          ];
          csvContent += rowData.map(escapeCSV).join(",") + "\n";
        });

        // Create and trigger download link
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `zorgcapaciteit-${region}-${new Date()
            .toISOString()
            .slice(0, 10)}.csv`
        ); // Add date
        document.body.appendChild(link); // Required for Firefox
        link.click();
        document.body.removeChild(link); // Clean up
        URL.revokeObjectURL(url); // Release memory
      }

      // --- Initialization and Event Listeners ---
      function initDashboard() {
        console.log("Initializing Dashboard...");

        // Load summary data first, then Arnhem data (default tab)
        loadDashboardSummary()
          .then(() => loadRegionData("arnhem", "zorginstellingen-arnhem.json")) // Adjust filename if needed
          .catch((error) =>
            console.error("Error during initial data load:", error)
          );

        // --- Event Listeners ---

        // Tab switching - Load Nijmegen data only when tab is shown
        const nijmegenTab = document.getElementById("nijmegen-tab");
        if (nijmegenTab) {
          nijmegenTab.addEventListener("shown.bs.tab", async (event) => {
            console.log("[Nijmegen Tab] 'shown.bs.tab' event fired.");
            // Check if data needs loading (only load once)
            if (zorghuizenData.nijmegen.length === 0) {
              console.log("[Nijmegen Tab] Data array empty, loading data...");
              // Adjust filename if needed
              await loadRegionData(
                "nijmegen",
                "zorginstellingen-nijmegen.json"
              );
            } else {
              console.log(
                "[Nijmegen Tab] Data already loaded, refreshing view."
              );
              // Re-populate in case filters/sort changed while tab was hidden
              populateTable("nijmegen");
            }
          });
        } else {
          console.error("Nijmegen tab element not found!");
        }

        // Sorting (using event delegation on table containers)
        document
          .getElementById("arnhemTableContainer")
          ?.addEventListener("click", (event) => {
            if (event.target.closest("th[data-sort]")) {
              // Check if click was on a sortable header
              handleSortClick(event.target.closest("th[data-sort]"), "arnhem");
            }
          });
        document
          .getElementById("nijmegenTableContainer")
          ?.addEventListener("click", (event) => {
            if (event.target.closest("th[data-sort]")) {
              handleSortClick(
                event.target.closest("th[data-sort]"),
                "nijmegen"
              );
            }
          });

        // Search filters (using 'input' event for real-time filtering)
        document
          .getElementById("searchArnhem")
          ?.addEventListener("input", function () {
            filters.arnhem = this.value;
            populateTable("arnhem");
          });
        document
          .getElementById("searchNijmegen")
          ?.addEventListener("input", function () {
            filters.nijmegen = this.value;
            populateTable("nijmegen");
          });

        // CSV Downloads
        document
          .getElementById("downloadCsvArnhem")
          ?.addEventListener("click", () => downloadCSV("arnhem"));
        document
          .getElementById("downloadCsvNijmegen")
          ?.addEventListener("click", () => downloadCSV("nijmegen"));

        console.log("Dashboard Initialized.");
      }

      // Start the application once the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
  </body>
</html>
